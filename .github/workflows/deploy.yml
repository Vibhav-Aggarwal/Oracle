name: Deploy Oracle Trading Bot

on:
  push:
    branches: [main]
    paths:
      - '*.py'
      - 'requirements.txt'
      - 'docker-compose.yml'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || echo "No requirements.txt"
          pip install pytest ruff || true

      - name: Lint
        run: ruff check . || echo "No ruff config"

      - name: Test
        run: pytest tests/ -v || echo "No tests yet"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: http://92.4.88.143:8080

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH Key
        env:
          SSH_KEY: ${{ secrets.ORACLE_CLOUD_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan 92.4.88.143 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Wait Random Delay (Prevent Concurrent SSH)
        run: |
          DELAY=$((RANDOM % 30))
          echo "Waiting ${DELAY}s to prevent concurrent deployments..."
          sleep $DELAY

      - name: Deploy to Oracle Cloud Server
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 ubuntu@92.4.88.143 << 'ENDSSH'
            cd /home/ubuntu/Projects/production/oracle

            echo "üì• Pulling latest code..."
            git pull origin main || echo "Git pull failed (expected on first deploy)"

            echo "üì¶ Updating dependencies..."
            ./venv/bin/pip install -r requirements.txt --quiet

            echo "üîÑ Restarting Oracle bot service..."
            sudo systemctl restart oracle-bot || echo "Service not enabled yet"

            echo "‚è≥ Waiting for service to start..."
            sleep 5

            echo "üîç Checking service status..."
            sudo systemctl status oracle-bot --no-pager || true

            echo "üìä Checking if bot is responding..."
            curl -f http://localhost:8080/health 2>/dev/null && echo "‚úÖ Health check passed" || echo "‚ö†Ô∏è Health check failed (bot may need API credentials)"

            echo "‚úÖ Deployment complete"
          ENDSSH

      - name: Deployment Complete
        run: echo "‚úÖ Oracle bot deployed to Oracle Cloud Server (92.4.88.143)"
